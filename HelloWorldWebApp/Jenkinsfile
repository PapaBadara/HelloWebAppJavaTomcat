pipeline {
    agent any

    tools {
        git 'Default' 
        jdk 'JDK17'
        maven 'Maven3'
    }

    stages {

        stage('Checkout') {
            steps {
                // Nettoie le workspace pour éviter les fichiers bloqués
                deleteDir() 
                
                // Clone le projet depuis GitHub
                git branch: 'main',
                    url: 'https://github.com/PapaBadara/HelloWebAppJavaTomcat.git'
            }
        }

        stage('Build') {
            steps {
                dir('HelloWorldWebApp') {
                    // Compile et package le projet Java
                    sh 'mvn clean package'
                }
            }
        }

        stage('Archive WAR') {
            steps {
                dir('HelloWorldWebApp') {
                    // Archive le WAR généré pour pouvoir le retrouver dans Jenkins
                    archiveArtifacts artifacts: 'target/*.war', fingerprint: true
                }
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                // Déploie le WAR sur Tomcat via le plugin Jenkins Tomcat
                deploy adapters: [
                    tomcat9(
                        credentialsId: 'tomcat-creds',  // Vérifie que ce credential existe
                        url: 'http://10.163.12.54:8081' // IP accessible depuis Jenkins Docker
                    )
                ],
                contextPath: 'HelloWorldWebApp',
                war: 'HelloWorldWebApp/target/HelloWorldWebApp-1.0-SNAPSHOT.war'
            }
        }
    }

    post {
        success {
            echo "✅ Build et déploiement réussis"
        }
        failure {
            echo "❌ Erreur dans le pipeline"
        }
    }
}
